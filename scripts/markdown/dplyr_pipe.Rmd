---
title: "dplyr and pipes"
output: html_notebook
---

# Install the tidyverse package set
Most usefull packages for modern R code : https://www.tidyverse.org/packages/ 
Installs ggplot2, dplyr, tidyr, readr, purr, tibble and much more:
‘colorspace’, ‘mnormt’, ‘bindr’, ‘RColorBrewer’, ‘dichromat’, ‘munsell’, ‘labeling’, ‘viridisLite’, ‘rematch’, ‘plyr’, ‘psych’, ‘reshape2’, ‘assertthat’, ‘bindrcpp’, ‘glue’, ‘pkgconfig’, ‘rlang’, ‘R6’, ‘Rcpp’, ‘BH’, ‘plogr’, ‘digest’, ‘gtable’, ‘scales’, ‘lazyeval’, ‘mime’, ‘curl’, ‘openssl’, ‘cellranger’, ‘stringi’, ‘selectr’, ‘tidyselect’, ‘broom’, ‘dplyr’, ‘forcats’, ‘ggplot2’, ‘haven’, ‘httr’, ‘hms’, ‘jsonlite’, ‘lubridate’, ‘magrittr’, ‘modelr’, ‘purrr’, ‘readr’, ‘readxl’, ‘stringr’, ‘tibble’, ‘rvest’, ‘tidyr’, ‘xml2’

```{r, warning=F}
# install.packages("tidyverse")
library(tidyverse, quietly = T)

vignette("dplyr")
```

# Load some datesets
```{r}
#install.packages("datasets")
# install.packages("mlbench") 

# library(help= "mlbench") (Glass, BreastCancer, BostonHousin, Ionosphere, PimaIndiansDiabetes, Sonar)

library(mlbench)
data("BostonHousing")
BostonHousing

data("HairEyeColor")
HairEyeColor

data("mtcars")
mtcars

data("storms")
storms

data("BreastCancer")
BreastCancer


```
# Use TidyR / Reshape2
```{r}

# convert matrix to data.frame
HairEyeColor %>% reshape2::melt() %>% as.tibble -> tib
tib = as.tibble(HairEyeColor) # !! Does not transforms character columns as factor

# Unite several columns into one 
storms %>% unite(date, day:year, sep = "-")


# Separate values into new column based on pattern
example <- tibble(`N [ears]` = c("173", "60", "54 [96]", "168 [328]", "906 [1685]"), 
                  `% Otorrhea` = c("58.61%", "13.30%", "11.11%", "52.38%", "14.79% [10.45%]"))

example %>% 
    separate(`N [ears]`, into = c("N_patients", "N_ears"), sep = "\\s\\[", fill = "right") %>%
    separate(`% Otorrhea`, into = c("pct_patients", "pct_ears"), sep = "\\s\\[", fill = "right") %>%
    mutate_each(funs(parse_number))



HairEyeColor




```
# Manipulate data with dplyr and the pipe operator

```{r} 
vignette("dplyr")
 
# Filtering and selecting
tib %>% filter(Sex == "Male", Eye=="Brown")
tib %>% select(contains('S'))
tib %>% select(Eye:value)


mtcars %>% 
  group_by(cyl, am) %>%
  select(mpg, cyl, wt, am) %>%
  summarise(avgmpg = mean(mpg), avgwt = mean(wt)) %>%
  filter(avgmpg > 20)

# cw %>% group_by(sid) %>% summarise(accuracy = mean(correct)) %>% arrange(desc(accuracy))

```

## Recode
http://dplyr.tidyverse.org/reference/recode.html
```{r}

```

## Using functional sequences

```{r}
library(magrittr) # needed to include the pipe operators
# library(lubridate) in tidyverse 
read_year <- . %>% as.character %>% as.Date %>% year

# Creating a dataset
df <- data.frame(now = "2015-11-11", before = "2012-01-01")
#          now     before
# 1 2015-11-11 2012-01-01

# Example 1: applying `read_year` to a single character-vector
df$now %>% read_year
# [1] 2015

# Example 2: applying `read_year` to all columns of `df`
df %>% lapply(read_year) %>% as.data.frame  # implicit `lapply(df, read_year)
#    now before
# 1 2015   2012

# Example 3: same as above using `mutate_all`
library(dplyr)
df %>% mutate_all(funs(read_year))
# if an older version of dplyr use `mutate_each`
#    now before
# 1 2015   2012
```

## Assignment

```{r}
df <- df %>% select(1:3) %>% filter(mpg > 20, cyl == 6)

df %>% select(1:3) %>% filter(mpg > 20, cyl == 6) -> df

df %<>% select(1:3) %>% filter(mpg > 20, cyl == 6)

all_letters <- c(letters, LETTERS) %>%
    sort %T>% 
    write.csv(file = "all_letters.csv")

# %T>% (tee operator) allows you to forward a value into a side-effect-producing function while keeping the original lhs value intact. In other words: the tee operator works like %>%, except the return values is lhs itself, and not the result of the rhs function/expression
# 

library(ggplot2)
diamonds %>% 
    filter(depth > 60) %>% 
    group_by(cut) %>% 
    summarize(mean_price = mean(price)) %>% 
    ggplot(aes(x = cut, y = mean_price)) + 
        geom_bar(stat = "identity")



```

# TidyR
```{r}
# Best organization for datasets
# Each variable has its own column
# Each observation in its own row
# Each value is placed in its own cell

library(tidyr)

gather()

# nested dataframes
data %>% group_by(x) %>% nest()
```


# BROOM
http://varianceexplained.org/r/broom-intro/

# Survival
https://github.com/pavopax/gists/blob/master/survival-in-R.md 

# Purrr

```{r}

map(data, function())

```
